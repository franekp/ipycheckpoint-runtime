<html>
  <head>
    <title>Example bridge between a host app and JupyterLite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            height: calc(100vh - 200px);
            position: relative;
            overflow: hidden;
        }

        .iframe-container {
            width: 100%;
            height: 100%;
            border: none;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        .loading-bar-container {
            width: calc(100vw - 200px);
            height: 40px;
            border: 4px solid white;
            background: transparent;
            position: relative;
            overflow: hidden;
            padding: 4px;
        }

        .loading-bar {
            width: 0%;
            height: 100%;
            background: white;
            animation: loadingProgress 25s linear infinite;
        }

        @keyframes loadingProgress {
            0% { width: 0%; }
            100% { width: 100%; }
        }
    </style>
  </head>
  <body>
    <script type="text/javascript">
      /*
        type Message =
          | { kind: 'IFrameToHost', type: 'InitialPayloadRequest' }
          | { kind: 'HostToIFrame', type: 'InitialPayloadResponse', envInitializer: string, initialCells: string[] }
          | { kind: 'IFrameToHost', type: 'NotebookReady' }
      */

      const envInitializer = 'injected_var = "Hello World!"';
      const printInheritedEnv = `
print('Inherited globals:')
for _k, _v in list(globals().items()):
    if _k.startswith('_') or _k in ['In', 'Out', 'exit', 'quit', 'open', 'get_ipython']: continue
    print(f'    {_k}: {type(_v).__name__}')
`.trim();
      const helloWorld = "print('Hello world!')";
      const initialCells = [printInheritedEnv, helloWorld];

      /* Incoming messages */
      window.addEventListener('message', (event) => {
        const data = event.data;
        const iframe = document.querySelector('#embedded-jupyterlab-123');
        if (!iframe) {
          console.error('IFrame "#embedded-jupyterlab-123" not found!');
          return
        }
        if (data.type == 'InitialPayloadRequest') {
          console.log(`HOST PAGE: 'InitialPayloadRequest' received! responding...`);
          iframe.contentWindow.postMessage({
            kind: 'HostToIFrame',
            type: 'InitialPayloadResponse',
            envInitializer, initialCells,
          }, '*');
        } else if (data.type == 'NotebookReady') {
          document.querySelector('.overlay').style.display = 'none';
        } else {
          console.log(`HOST PAGE: unknown message '${event.data.type}' received!`);
        }
      });
    </script>
    <h2>Below is a JupyterLite site running in an IFrame</h2>
    <div class="container">
      <iframe
        id="embedded-jupyterlab-123"
        class="iframe-container"
        name="jupyterlab"
        src="site/"
        sandbox="allow-scripts allow-same-origin"
      ></iframe>
      <div class="overlay">
          <div class="loading-bar-container">
              <div class="loading-bar"></div>
          </div>
      </div>
    </div>
    
  </body>
</html>
